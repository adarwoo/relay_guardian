<SectionLabel@MDLabel>:
   font_style: "H6"
   theme_text_color: "Primary"
   size_hint_y: None
   height: self.texture_size[1] + dp(16)
   bold: True

<SubSectionLabel@MDLabel>:
   font_style: "Subtitle1"
   theme_text_color: "Secondary"
   size_hint_y: None
   height: self.texture_size[1] + dp(10)
   bold: True

<ModernButton@MDRectangleFlatButton>:
   md_bg_color: 0.2, 0.5, 0.8, 1
   text_color: 1, 1, 1, 1
   font_size: '15sp'
   size_hint_y: None
   height: dp(36)

<ModernSwitch@MDSwitch>:
   size_hint_y: None
   height: dp(36)

MDBoxLayout:
   orientation: 'vertical'
   padding: dp(24)
   spacing: dp(18)

   MDLabel:
      text: "Modbus Relay GUI"
      font_style: "H4"
      theme_text_color: "Primary"
      size_hint_y: None
      height: dp(40)
      halign: "center"
      bold: True

   MDGridLayout:
      cols: 2
      spacing: dp(24)
      size_hint_y: 0.9

      # --- Status & Diagnostics ---
      MDCard:
         orientation: 'vertical'
         padding: dp(12)
         spacing: dp(10)
         radius: [12]
         elevation: 4
         SectionLabel:
            text: "Status & Diagnostics"
         MDGridLayout:
            cols: 2
            spacing: dp(6)
            size_hint_y: None
            height: self.minimum_height

            MDLabel:
               text: "Running Time (min):"
            MDLabel:
               text: app.running_time

            MDLabel:
               text: "Relay Cycles:"
            MDLabel:
               text: app.relay_cycles

            MDLabel:
               text: "Live In-Feed Voltage:"
            MDLabel:
               text: app.live_voltage

            MDLabel:
               text: "Voltage Max:"
            MDLabel:
               text: app.voltage_max

            MDLabel:
               text: "Voltage Min:"
            MDLabel:
               text: app.voltage_min

            MDLabel:
               text: "EStop Status:"
            MDLabel:
               text: app.estop_status

            MDLabel:
               text: "EStop Source:"
            MDLabel:
               text: app.estop_source

            MDLabel:
               text: "EStop Fault Code:"
            MDLabel:
               text: app.estop_fault_code

            MDLabel:
               text: "Software Version:"
            MDLabel:
               text: app.software_version

            MDLabel:
               text: "Firmware Version:"
            MDLabel:
               text: app.firmware_version

            MDLabel:
               text: "Identification:"
            MDLabel:
               text: app.device_id

         MDBoxLayout:
            orientation: 'horizontal'
            spacing: dp(8)
            size_hint_y: None
            height: dp(36)
            ModernButton:
               text: "Reset EStop"
               on_release: app.reset_estop()
            ModernButton:
               text: "Reset In-Feed Min/Max"
               on_release: app.reset_infeed_minmax()

      # --- Control ---
      MDCard:
         orientation: 'vertical'
         padding: dp(12)
         spacing: dp(10)
         radius: [12]
         elevation: 4
         SectionLabel:
            text: "Control"
         MDBoxLayout:
            orientation: 'horizontal'
            spacing: dp(10)
            MDLabel:
               text: "Locate"
               size_hint_x: None
               width: dp(80)
            ModernSwitch:
               active: False
               on_active: app.toggle_locate(self.active)

         MDGridLayout:
            cols: 3
            spacing: dp(8)
            size_hint_y: None
            height: dp(120)

            SubSectionLabel:
               text: "Relay"
            SubSectionLabel:
               text: "Status"
            SubSectionLabel:
               text: "Fault"

            # Relay 1
            MDLabel:
               text: "Relay 1"
            ModernSwitch:
               active: app.relay1_state == "on"
               on_active: app.toggle_relay(1, self.active)
               disabled: app.relay1_fault
            MDLabel:
               text: "Fault" if app.relay1_fault else ""
               theme_text_color: "Error" if app.relay1_fault else "Primary"

            # Relay 2
            MDLabel:
               text: "Relay 2"
            ModernSwitch:
               active: app.relay2_state == "on"
               on_active: app.toggle_relay(2, self.active)
               disabled: app.relay2_fault
            MDLabel:
               text: "Fault" if app.relay2_fault else ""
               theme_text_color: "Error" if app.relay2_fault else "Primary"

            # Relay 3
            MDLabel:
               text: "Relay 3"
            ModernSwitch:
               active: app.relay3_state == "on"
               on_active: app.toggle_relay(3, self.active)
               disabled: app.relay3_fault
            MDLabel:
               text: "Fault" if app.relay3_fault else ""
               theme_text_color: "Error" if app.relay3_fault else "Primary"

         MDBoxLayout:
            orientation: 'horizontal'
            spacing: dp(8)
            ModernButton:
               text: "Pulse EStop"
               on_release: app.pulse_estop()
            ModernButton:
               text: "Terminal EStop"
               on_release: app.terminal_estop()
            ModernButton:
               text: "Resettable EStop"
               on_release: app.resettable_estop()

         MDBoxLayout:
            orientation: 'horizontal'
            spacing: dp(8)
            MDLabel:
               text: "EStop Context Code:"
               size_hint_x: 0.5
            MDTextField:
               id: estop_context_code
               text: app.estop_context_code
               mode: "rectangle"
               size_hint_x: 0.5
               input_filter: 'int'
               on_text_validate: app.set_estop_context_code(self.text)

      # --- Configuration ---
      MDCard:
         orientation: 'vertical'
         padding: dp(12)
         spacing: dp(10)
         radius: [12]
         elevation: 4
         SectionLabel:
            text: "Configuration"
         SubSectionLabel:
            text: "Communication"
         MDGridLayout:
            cols: 2
            spacing: dp(6)
            size_hint_y: None
            height: self.minimum_height

            MDLabel:
               text: "Device ID:"
            MDTextField:
               text: app.device_id
               mode: "rectangle"
               input_filter: 'int'
               on_text_validate: app.set_device_id(self.text)

            MDLabel:
               text: "Baud Rate:"
            MDSpinner:
               text: app.baud_rate
               values: ["115200", "57600", "38400", "19200", "9600", "4800", "2400", "1200", "600", "300"]
               on_text: app.set_baud_rate(self.text)

            MDLabel:
               text: "Stop Bits:"
            MDSpinner:
               text: app.stop_bits
               values: ["1", "2"]
               on_text: app.set_stop_bits(self.text)

            MDLabel:
               text: "Parity:"
            MDSpinner:
               text: app.parity
               values: ["Odd", "Even", "None"]
               on_text: app.set_parity(self.text)

         SubSectionLabel:
            text: "Infeed"
         MDGridLayout:
            cols: 2
            spacing: dp(6)
            size_hint_y: None
            height: self.minimum_height

            MDLabel:
               text: "Supply Voltage Type:"
            MDSpinner:
               text: app.supply_voltage_type
               values: ["AC 50Hz", "AC 60Hz", "DC"]
               on_text: app.set_supply_voltage_type(self.text)

            MDLabel:
               text: "Low Supply Alarm Threshold:"
            MDTextField:
               text: app.low_alarm
               mode: "rectangle"
               input_filter: 'int'
               on_text_validate: app.set_low_alarm(self.text)

            MDLabel:
               text: "Upper Supply Alarm Threshold:"
            MDTextField:
               text: app.upper_alarm
               mode: "rectangle"
               input_filter: 'int'
               on_text_validate: app.set_upper_alarm(self.text)

      # --- Server Setup ---
      MDCard:
         orientation: 'vertical'
         padding: dp(12)
         spacing: dp(10)
         radius: [12]
         elevation: 4
         SectionLabel:
            text: "Server Setup"
         MDGridLayout:
            cols: 2
            spacing: dp(6)
            size_hint_y: None
            height: self.minimum_height

            MDLabel:
               text: "Comm Port:"
            MDSpinner:
               text: app.comm_port
               values: ["COM1", "COM2", "COM3", "COM4", "COM5", "COM6", "COM7", "COM8"]
               on_text: app.set_comm_port(self.text)

            MDLabel:
               text: "Baud Rate:"
            MDSpinner:
               text: app.server_baud_rate
               values: ["115200", "57600", "38400", "19200", "9600", "4800", "2400", "1200", "600", "300"]
               on_text: app.set_server_baud_rate(self.text)

            MDLabel:
               text: "Stop Bits:"
            MDSpinner:
               text: app.server_stop_bits
               values: ["1", "2"]
               on_text: app.set_server_stop_bits(self.text)

            MDLabel:
               text: "Parity:"
            MDSpinner:
               text: app.server_parity
               values: ["Odd", "Even", "None"]
               on_text: app.set_server_parity(self.text)

            MDLabel:
               text: "RTS Enabled:"
            ModernSwitch:
               active: app.rts_enabled
               on_active: app.set_rts_enabled(self.active)